---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import Tag from "@components/Tag.astro";
import type { CollectionEntry } from "astro:content";
import BlobIcon from "@components/BlobIcon.astro";
import LinkList from "@components/LinkList.astro";
import { getCollection } from "astro:content";

export interface Props {
  post: CollectionEntry<"garden" | "stream" | "page" | "now">;
  collection: "garden" | "stream";
}

const { post, collection } = Astro.props;

const {
  title,
  description,
  ogImage,
  publishDatetime,
  updateDatetime,
  tags,
  incomingLinks,
  outgoingLinks,
} = post.data as CollectionEntry<"garden" | "stream">["data"];

const noteState = "noteState" in post.data ? post.data.noteState : undefined;

const { Content } = await post.render();

const ogUrl = new URL(ogImage ? ogImage : `${post.slug}.svg`, Astro.url.origin)
  .href;

const noteType = noteState ? post.data.noteState : post.data.streamType;
const fullUpdateDate = updateDatetime.toLocaleDateString([], {
  year: "numeric",
  month: "short",
  day: "numeric",
});
const fullPublishDate = publishDatetime.toLocaleDateString([], {
  year: "numeric",
  month: "short",
  day: "numeric",
});
const updateYear = updateDatetime.toLocaleDateString([], {
  year: "numeric",
});

const updateMonth = updateDatetime.toLocaleDateString([], {
  month: "short",
});

const updateDay = updateDatetime.toLocaleDateString([], {
  day: "numeric",
});

// Fetch all posts for link validation
const allGardenNotes = await getCollection("garden");
const allStreams = await getCollection("stream");
const allContent = [...allGardenNotes, ...allStreams];
const dateType =
  new Date(updateDatetime) > new Date(publishDatetime)
    ? "Updated"
    : "Published";
---

<Layout
  title={title}
  description={description}
  ogImage={ogUrl}
  hasWaveSeparator={false}
>
  <Fragment slot="header">
    <Header activeNav={collection} />
  </Fragment>

  <main id="main-content" class="relative">
    <div class="w-full">
      <div
        class="relative pt-16 border-t-2 border-dashed border-skin-card flex"
      >
        <div
          class="uppercase absolute -top-11 left-1/2 transform -translate-x-1/2 flex items-center w-full justify-center"
        >
          <span class="z-30 translate-x-4 contrast-125 -rotate-[25deg]">
            <BlobIcon type={noteType} className="size-12 scale-150" />
          </span>
          <span
            class="relative flex items-center pl-6 flex-col border border-skin-card bg-skin-card/60 py-1 px-3"
          >
            {noteType}
          </span>
          <div class="flex flex-col border-skin-card border py-1 px-3">
            <span class="">
              {fullUpdateDate}
            </span>
          </div>
        </div>

        <h1 class="post-title px-8">
          {title} this is a really really long title to see what happens when the
          title wraps and I'm not sure if I can type without seeing.
        </h1>
      </div>
      <article
        id="article"
        role="article"
        class="prose mx-auto mt-8 pt-8 max-w-3xl"
      >
        <Content />
        {
          tags && tags.length > 0 && (
            <ul class="tags-container">
              {tags.map((tag: string) => (
                <Tag name={tag} />
              ))}
            </ul>
          )
        }
      </article>
      <div class="mt-28 flex gap-12">
        <LinkList
          links={incomingLinks || []}
          type="incoming"
          allPosts={allContent}
        />
        <LinkList
          links={outgoingLinks || []}
          type="outgoing"
          allPosts={allContent}
        />
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<style>
  main {
    @apply mx-auto relative z-20 w-full max-w-5xl px-4 pt-24 pb-12  flex gap-8;
  }

  aside {
    display: none;
  }

  #article {
    @apply border-b-2 border-dashed border-skin-card/40;
  }

  .post-title {
    @apply text-4xl font-extrabold text-skin-accent;
  }
  .tags-container {
    @apply mt-8 ml-0 p-0;
  }
</style>
